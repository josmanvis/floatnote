---
phase: 01-integration-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - jest.config.js
  - tests/integration/ipc-handlers.test.js
autonomous: true

must_haves:
  truths:
    - "save-data handler writes JSON to dataFilePath and returns {success: true}"
    - "load-data handler reads back what save-data wrote and returns parsed object"
    - "load-data returns {success: true, data: null} when no file exists"
    - "export-to-floatnote creates ~/.floatnote dir and writes note-{id}.json"
    - "export-png shows save dialog, writes base64-decoded PNG, returns {success: true, path}"
    - "open-floatnote-folder calls shell.openPath on the floatnote folder"
    - "close-window triggers window closure via BrowserWindow"
    - "hide-window triggers window hiding via BrowserWindow"
    - "set-pinned keeps window on top when pinned, removes when unpinned"
    - "set-window-size computes bounds from screen size and calls win.setBounds()"
    - "resize-window-left adjusts x and width based on deltaX with 200px min"
    - "open-file calls shell.openPath when file exists"
  artifacts:
    - path: "tests/integration/ipc-handlers.test.js"
      provides: "IPC handler round-trip integration tests"
      min_lines: 150
    - path: "jest.config.js"
      provides: "Integration test project configuration"
      contains: "integration"
  key_links:
    - from: "tests/integration/ipc-handlers.test.js"
      to: "src/main.js"
      via: "require('../../src/main.js') which registers handlers"
      pattern: "require.*src/main"
    - from: "tests/integration/ipc-handlers.test.js"
      to: "ipcMain handlers"
      via: "handler capture mock stores registered handlers"
      pattern: "handlers\\["
---

<objective>
Create integration tests that verify all IPC handler round-trips in main.js by requiring the actual source module with a handler-capturing electron mock.

Purpose: Verify that main.js IPC handlers (save/load data, exports, window management) produce correct side effects and return values when invoked -- using the real handler code, not re-implemented mocks.

Output: `tests/integration/ipc-handlers.test.js` with passing tests for all 11 IPC channels, plus jest.config.js updated with integration project.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/1/RESEARCH.md
@src/main.js
@jest.config.js
@tests/mocks/electron.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add integration project to jest.config.js</name>
  <files>jest.config.js</files>
  <action>
Add a new project entry to the `projects` array in jest.config.js:

```javascript
{
  displayName: 'integration',
  testEnvironment: 'node',
  testMatch: ['<rootDir>/tests/integration/**/*.test.js'],
  moduleNameMapper: {
    '^electron$': '<rootDir>/tests/mocks/electron.js'
  }
}
```

Place it after the existing `preload` project entry. The moduleNameMapper points to the existing electron mock -- the integration test will override with inline jest.mock() to add handler capture.

Do NOT modify any existing project entries.
  </action>
  <verify>Run `npx jest --listProjects 2>&1 | grep integration` and confirm the integration project appears.</verify>
  <done>jest.config.js has 5 projects (main, renderer, cli, preload, integration) and the integration project uses node environment with tests/integration glob.</done>
</task>

<task type="auto">
  <name>Task 2: Create IPC handler integration tests</name>
  <files>tests/integration/ipc-handlers.test.js</files>
  <action>
Create `tests/integration/ipc-handlers.test.js` that:

1. **Mocks `fs` inline** with an in-memory fileStore object (reset in beforeEach):
   - `existsSync(path)` -> checks `path in fileStore`
   - `readFileSync(path, encoding)` -> returns `fileStore[path]` or throws ENOENT
   - `writeFileSync(path, content)` -> sets `fileStore[path] = content`
   - `mkdirSync()` -> no-op jest.fn()

2. **Mocks `electron` inline** with handler capture:
   - `ipcMain.handle(channel, fn)` stores fn in a `handlers` map
   - `ipcMain.on(channel, fn)` stores fn in a `listeners` map
   - `app.getPath('userData')` returns `/mock/userData`
   - `app.getPath('home')` returns `/mock/home`
   - `app.requestSingleInstanceLock()` returns true
   - `app.whenReady()` returns resolved Promise
   - `app.on()`, `app.quit()`, `app.exit()` are jest.fn()
   - `app.dock` has `setIcon: jest.fn()`
   - `BrowserWindow` constructor returns mockBrowserWindow object with: close, hide, show, focus, setAlwaysOnTop, setBounds, getBounds (returns {x:100, y:0, width:800, height:600}), setVisibleOnAllWorkspaces, setVibrancy, setBackgroundColor, loadFile, on, isDestroyed (returns false), webContents: {send: jest.fn()}
   - `BrowserWindow.fromWebContents` returns the mockBrowserWindow
   - `BrowserWindow.getAllWindows` returns []
   - `screen.getCursorScreenPoint()` returns {x:500, y:500}
   - `screen.getDisplayNearestPoint()` returns {workAreaSize: {width:1920, height:1080}, workArea: {x:0, y:0}}
   - `globalShortcut` with register/unregisterAll jest.fn()
   - `dialog.showSaveDialog` returns Promise of {canceled: false, filePath: '/test/export.png'}
   - `dialog.showMessageBox` returns Promise of {response: 0}
   - `shell.openPath` returns Promise of ''
   - `Tray` constructor returns {setToolTip: jest.fn(), on: jest.fn(), popUpContextMenu: jest.fn()}
   - `Menu.buildFromTemplate` returns {}
   - `nativeImage.createFromDataURL` returns {setTemplateImage: jest.fn()}

3. **Requires actual main.js** after mocks are set up:
   ```javascript
   require('../../src/main.js');
   ```

4. **Creates mockEvent** for handler invocation:
   ```javascript
   const mockEvent = { sender: { id: 1 } };
   ```

5. **Tests all 11 IPC channels, organized into logical groups:**

   **Data persistence handlers** (save-data, load-data, export-to-floatnote, export-png, open-floatnote-folder):
   - Verify save/load round-trip data fidelity (write then read back, compare)
   - Verify graceful handling when no file exists (returns null data, not error)
   - Verify error paths (write failure, read failure) return {success: false, error}
   - Verify export handlers produce correct file I/O (folder creation, correct paths)
   - Verify export-png shows dialog and writes decoded buffer
   - Verify open-floatnote-folder calls shell.openPath

   **Window management handlers** (close-window, hide-window, set-pinned, set-window-size, resize-window-left, open-file):
   - Verify close/hide call corresponding BrowserWindow methods
   - Verify set-pinned toggles alwaysOnTop with correct params
   - Verify set-window-size computes correct bounds for each size preset
   - Verify resize-window-left adjusts bounds with minimum width enforcement
   - Verify open-file calls shell.openPath for existing files, no-ops for missing

6. **beforeEach** resets fileStore to empty object and calls jest.clearAllMocks().

Key implementation notes:
- For `ipcMain.handle` handlers, invoke as `await handlers['channel-name'](mockEvent, args)`
- For `ipcMain.on` listeners, invoke as `listeners['channel-name'](mockEvent, args)`
- The save-data handler writes to `/mock/userData/floatnote-data.json` (path.join of getPath('userData') + 'floatnote-data.json')
- The export-to-floatnote handler writes to `/mock/home/.floatnote/note-{id}.json`
- For export-png, the imageDataUrl should be `'data:image/png;base64,iVBORw0KGgo='` (valid-ish base64 prefix)
- Use `jest.spyOn(console, 'error').mockImplementation(() => {})` in error tests to suppress noise
- Use `jest.spyOn(console, 'log').mockImplementation(() => {})` globally to suppress main.js startup logs
  </action>
  <verify>Run `npx jest --selectProjects=integration --verbose` and confirm all tests pass with no failures.</verify>
  <done>All 11 IPC channels have passing integration tests that exercise the actual handler code from main.js. Tests verify both success and error paths. No Electron window is launched.</done>
</task>

</tasks>

<verification>
1. `npx jest --selectProjects=integration` exits with code 0
2. `npx jest --selectProjects=integration --verbose 2>&1 | grep -c "PASS"` shows 1 (the test file passes)
3. `npx jest --selectProjects=main` still passes (existing tests unaffected)
4. `npx jest` runs all projects including integration without errors
</verification>

<success_criteria>
- All IPC handler integration tests pass
- Tests import actual main.js (not re-implemented mock logic)
- save/load round-trip proves data fidelity through the real handler code
- Window management handlers trigger correct BrowserWindow methods
- Export handlers produce correct file I/O and dialog interactions
- Existing test suites remain unaffected
- No Electron window launched during tests
</success_criteria>

<output>
After completion, create `.planning/phases/1/01-01-SUMMARY.md`
</output>
