---
phase: 01-integration-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - jest.config.js
  - tests/integration/ipc-handlers.test.js
autonomous: true

must_haves:
  truths:
    - "save-data handler writes JSON to dataFilePath and returns {success: true}"
    - "load-data handler reads back what save-data wrote and returns parsed object"
    - "load-data returns {success: true, data: null} when no file exists"
    - "export-to-floatnote creates ~/.floatnote dir and writes note-{id}.json"
    - "export-png shows save dialog, writes base64-decoded PNG, returns {success: true, path}"
    - "open-floatnote-folder calls shell.openPath on the floatnote folder"
    - "close-window calls win.close() on the sender's BrowserWindow"
    - "hide-window calls win.hide() on the sender's BrowserWindow"
    - "set-pinned calls win.setAlwaysOnTop(pinned, 'floating', 1)"
    - "set-window-size computes bounds from screen size and calls win.setBounds()"
    - "resize-window-left adjusts x and width based on deltaX with 200px min"
    - "open-file calls shell.openPath when file exists"
  artifacts:
    - path: "tests/integration/ipc-handlers.test.js"
      provides: "IPC handler round-trip integration tests"
      min_lines: 150
    - path: "jest.config.js"
      provides: "Integration test project configuration"
      contains: "integration"
  key_links:
    - from: "tests/integration/ipc-handlers.test.js"
      to: "src/main.js"
      via: "require('../../src/main.js') which registers handlers"
      pattern: "require.*src/main"
    - from: "tests/integration/ipc-handlers.test.js"
      to: "ipcMain handlers"
      via: "handler capture mock stores registered handlers"
      pattern: "handlers\\["
---

<objective>
Create integration tests that verify all IPC handler round-trips in main.js by requiring the actual source module with a handler-capturing electron mock.

Purpose: Verify that main.js IPC handlers (save/load data, exports, window management) produce correct side effects and return values when invoked -- using the real handler code, not re-implemented mocks.

Output: `tests/integration/ipc-handlers.test.js` with passing tests for all 11 IPC channels, plus jest.config.js updated with integration project.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/1/RESEARCH.md
@src/main.js
@jest.config.js
@tests/mocks/electron.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add integration project to jest.config.js</name>
  <files>jest.config.js</files>
  <action>
Add a new project entry to the `projects` array in jest.config.js:

```javascript
{
  displayName: 'integration',
  testEnvironment: 'node',
  testMatch: ['<rootDir>/tests/integration/**/*.test.js'],
  moduleNameMapper: {
    '^electron$': '<rootDir>/tests/mocks/electron.js'
  }
}
```

Place it after the existing `preload` project entry. The moduleNameMapper points to the existing electron mock -- the integration test will override with inline jest.mock() to add handler capture.

Do NOT modify any existing project entries.
  </action>
  <verify>Run `npx jest --listProjects 2>&1 | grep integration` and confirm the integration project appears.</verify>
  <done>jest.config.js has 5 projects (main, renderer, cli, preload, integration) and the integration project uses node environment with tests/integration glob.</done>
</task>

<task type="auto">
  <name>Task 2: Create IPC handler integration tests</name>
  <files>tests/integration/ipc-handlers.test.js</files>
  <action>
Create `tests/integration/ipc-handlers.test.js` that:

1. **Mocks `fs` inline** with an in-memory fileStore object (reset in beforeEach):
   - `existsSync(path)` -> checks `path in fileStore`
   - `readFileSync(path, encoding)` -> returns `fileStore[path]` or throws ENOENT
   - `writeFileSync(path, content)` -> sets `fileStore[path] = content`
   - `mkdirSync()` -> no-op jest.fn()

2. **Mocks `electron` inline** with handler capture:
   - `ipcMain.handle(channel, fn)` stores fn in a `handlers` map
   - `ipcMain.on(channel, fn)` stores fn in a `listeners` map
   - `app.getPath('userData')` returns `/mock/userData`
   - `app.getPath('home')` returns `/mock/home`
   - `app.requestSingleInstanceLock()` returns true
   - `app.whenReady()` returns resolved Promise
   - `app.on()`, `app.quit()`, `app.exit()` are jest.fn()
   - `app.dock` has `setIcon: jest.fn()`
   - `BrowserWindow` constructor returns mockBrowserWindow object with: close, hide, show, focus, setAlwaysOnTop, setBounds, getBounds (returns {x:100, y:0, width:800, height:600}), setVisibleOnAllWorkspaces, setVibrancy, setBackgroundColor, loadFile, on, isDestroyed (returns false), webContents: {send: jest.fn()}
   - `BrowserWindow.fromWebContents` returns the mockBrowserWindow
   - `BrowserWindow.getAllWindows` returns []
   - `screen.getCursorScreenPoint()` returns {x:500, y:500}
   - `screen.getDisplayNearestPoint()` returns {workAreaSize: {width:1920, height:1080}, workArea: {x:0, y:0}}
   - `globalShortcut` with register/unregisterAll jest.fn()
   - `dialog.showSaveDialog` returns Promise of {canceled: false, filePath: '/test/export.png'}
   - `dialog.showMessageBox` returns Promise of {response: 0}
   - `shell.openPath` returns Promise of ''
   - `Tray` constructor returns {setToolTip: jest.fn(), on: jest.fn(), popUpContextMenu: jest.fn()}
   - `Menu.buildFromTemplate` returns {}
   - `nativeImage.createFromDataURL` returns {setTemplateImage: jest.fn()}

3. **Requires actual main.js** after mocks are set up:
   ```javascript
   require('../../src/main.js');
   ```

4. **Creates mockEvent** for handler invocation:
   ```javascript
   const mockEvent = { sender: { id: 1 } };
   ```

5. **Tests these describe blocks:**

   **describe('save-data / load-data round-trip'):**
   - test: saves data and loads it back identically (write then read, compare objects)
   - test: load-data returns {success: true, data: null} when file does not exist
   - test: save-data returns {success: false, error} when writeFileSync throws
   - test: load-data returns {success: false, error} when readFileSync throws (set fileStore to invalid JSON)

   **describe('export-to-floatnote'):**
   - test: creates folder and writes note-{id}.json, returns {success: true, path}
   - test: returns {success: false, error} on write failure

   **describe('export-png'):**
   - test: shows save dialog, writes base64-decoded Buffer, returns {success: true, path}
   - test: returns {success: false, canceled: true} when dialog is canceled (mock showSaveDialog to return {canceled: true})
   - test: temporarily disables and re-enables alwaysOnTop during dialog

   **describe('open-floatnote-folder'):**
   - test: calls shell.openPath with floatnote folder path, returns {success: true}
   - test: creates folder if it does not exist

   **describe('window management - close-window'):**
   - test: calls win.close() via BrowserWindow.fromWebContents

   **describe('window management - hide-window'):**
   - test: calls win.hide() via BrowserWindow.fromWebContents

   **describe('window management - set-pinned'):**
   - test: calls win.setAlwaysOnTop(true, 'floating', 1) when pinned=true
   - test: calls win.setAlwaysOnTop(false, 'floating', 1) when pinned=false

   **describe('window management - set-window-size'):**
   - test: 'sm' sets bounds to 33% width, 50% height, bottom-right corner
   - test: 'md' sets bounds to 33% width, full height, right edge
   - test: 'lg' sets bounds to full screen
   - test: unknown size does not call setBounds

   **describe('resize-window-left'):**
   - test: positive deltaX increases x and decreases width
   - test: does not resize below 200px minimum width

   **describe('open-file'):**
   - test: calls shell.openPath when file exists
   - test: does not call shell.openPath when file does not exist

6. **beforeEach** resets fileStore to empty object and calls jest.clearAllMocks().

Key implementation notes:
- For `ipcMain.handle` handlers, invoke as `await handlers['channel-name'](mockEvent, args)`
- For `ipcMain.on` listeners, invoke as `listeners['channel-name'](mockEvent, args)`
- The save-data handler writes to `/mock/userData/floatnote-data.json` (path.join of getPath('userData') + 'floatnote-data.json')
- The export-to-floatnote handler writes to `/mock/home/.floatnote/note-{id}.json`
- For export-png, the imageDataUrl should be `'data:image/png;base64,iVBORw0KGgo='` (valid-ish base64 prefix)
- Use `jest.spyOn(console, 'error').mockImplementation(() => {})` in error tests to suppress noise
- Use `jest.spyOn(console, 'log').mockImplementation(() => {})` globally to suppress main.js startup logs
  </action>
  <verify>Run `npx jest --selectProjects=integration --verbose` and confirm all tests pass with no failures.</verify>
  <done>All 11 IPC channels have passing integration tests that exercise the actual handler code from main.js. Tests verify both success and error paths. No Electron window is launched.</done>
</task>

</tasks>

<verification>
1. `npx jest --selectProjects=integration` exits with code 0
2. `npx jest --selectProjects=integration --verbose 2>&1 | grep -c "PASS"` shows 1 (the test file passes)
3. `npx jest --selectProjects=main` still passes (existing tests unaffected)
4. `npx jest` runs all projects including integration without errors
</verification>

<success_criteria>
- All IPC handler integration tests pass
- Tests import actual main.js (not re-implemented mock logic)
- save/load round-trip proves data fidelity through the real handler code
- Window management handlers trigger correct BrowserWindow methods
- Export handlers produce correct file I/O and dialog interactions
- Existing test suites remain unaffected
- No Electron window launched during tests
</success_criteria>

<output>
After completion, create `.planning/phases/1/01-01-SUMMARY.md`
</output>
