---
phase: 03-cicd-pipeline
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/release.yml
autonomous: true

must_haves:
  truths:
    - "Pushing a version tag (v*) triggers a build that produces x64 and arm64 macOS DMG and ZIP artifacts"
    - "The tag-triggered build creates a GitHub Release with all artifacts attached"
    - "Release notes are auto-generated from commits since last tag"
    - "Builds succeed without code signing (CSC_IDENTITY_AUTO_DISCOVERY=false)"
    - "npm publish runs automatically after the release is created"
  artifacts:
    - path: ".github/workflows/release.yml"
      provides: "Build, release, and publish workflow"
      contains: "electron-builder"
  key_links:
    - from: ".github/workflows/release.yml"
      to: "package.json build config"
      via: "electron-builder reads build field"
      pattern: "electron-builder --mac"
    - from: ".github/workflows/release.yml (release job)"
      to: ".github/workflows/release.yml (publish-npm job)"
      via: "needs dependency"
      pattern: "needs:.*release"
---

<objective>
Restructure the existing release.yml to add build and release jobs triggered by version tag push, producing macOS x64+arm64 artifacts and creating a GitHub Release.

Purpose: Version tags automatically produce distributable artifacts and GitHub Releases, which then trigger npm publish.
Output: Updated `.github/workflows/release.yml` with build, release, and publish-npm jobs.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@package.json
@.github/workflows/release.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Restructure release.yml with build and release jobs</name>
  <files>.github/workflows/release.yml</files>
  <action>
Rewrite `.github/workflows/release.yml` to be triggered by tag push and contain three jobs:

**Trigger change:**
- Remove: `on: release: types: [published]`
- Add: `on: push: tags: ['v*']`

**Job 1: `build`**
- `runs-on: macos-latest`
- Strategy matrix for arch: `[x64, arm64]`
- Steps:
  1. `actions/checkout@v4`
  2. `actions/setup-node@v4` with `node-version: '20'`
  3. `run: npm ci`
  4. `run: npm test` (gate: tests must pass before building)
  5. Build: `npx electron-builder --mac --${{ matrix.arch }} --publish never`
     env: `CSC_IDENTITY_AUTO_DISCOVERY: false` (skip code signing)
  6. `actions/upload-artifact@v4` to upload `dist/` contents
     - Use artifact name like `macos-${{ matrix.arch }}`
     - Path: `dist/*.dmg` and `dist/*.zip` (use multiline path with both patterns)

**Job 2: `release`**
- `needs: build`
- `runs-on: ubuntu-latest`
- Steps:
  1. `actions/download-artifact@v4` with `merge-multiple: true` to download all build artifacts into one directory
  2. Create GitHub Release using `softprops/action-gh-release@v2`:
     - `tag_name: ${{ github.ref_name }}`
     - `generate_release_notes: true`
     - `files:` glob pattern for `*.dmg` and `*.zip`
- Permissions: `contents: write` (needed for release creation)

**Job 3: `publish-npm`**
- `needs: release`
- `runs-on: ubuntu-latest`
- Steps (keep existing):
  1. `actions/checkout@v4`
  2. `actions/setup-node@v4` with `node-version: '20'` and `registry-url: 'https://registry.npmjs.org'`
  3. `run: npm publish` with env `NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}`

**Important details:**
- Add top-level `permissions: contents: write` for the release job to create releases
- The build matrix produces 4 artifacts total: x64 DMG, x64 ZIP, arm64 DMG, arm64 ZIP
- electron-builder uses the `build` config from package.json (appId, productName, mac targets)
- `--publish never` in build step prevents electron-builder from trying to publish directly
- The `softprops/action-gh-release@v2` action handles creating the release AND uploading assets
- `generate_release_notes: true` uses GitHub's auto-generated release notes from commits (CICD-05)
  </action>
  <verify>
Validate YAML syntax: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/release.yml'))"`
Verify the file contains:
- Tag push trigger (`tags: ['v*']`)
- Build job with matrix (x64, arm64)
- CSC_IDENTITY_AUTO_DISCOVERY: false
- electron-builder command
- upload-artifact step
- Release job with download-artifact and softprops/action-gh-release
- generate_release_notes: true
- publish-npm job with needs: release
  </verify>
  <done>
`.github/workflows/release.yml` contains build (matrix x64+arm64, macos runner, electron-builder), release (creates GitHub Release with artifacts), and publish-npm (publishes to npm after release) jobs. Tag push `v*` triggers the entire pipeline.
  </done>
</task>

</tasks>

<verification>
- `.github/workflows/release.yml` is valid YAML
- Trigger is `push: tags: ['v*']`
- Build job runs on macos-latest with arch matrix [x64, arm64]
- Build job sets CSC_IDENTITY_AUTO_DISCOVERY=false
- Build job runs tests before building
- Build job uploads DMG and ZIP artifacts
- Release job downloads artifacts and creates GitHub Release
- Release uses generate_release_notes: true
- publish-npm job depends on release job
- publish-npm still has NPM_TOKEN and registry-url configuration
</verification>

<success_criteria>
- `npm version patch && git push --follow-tags` would trigger the workflow
- Build produces x64 and arm64 DMG + ZIP (4 artifacts total)
- GitHub Release is created with all artifacts attached and auto-generated notes
- npm publish runs only after successful release creation
- No code signing attempted (CSC_IDENTITY_AUTO_DISCOVERY=false)
</success_criteria>

<output>
After completion, create `.planning/phases/3/03-02-SUMMARY.md`
</output>
