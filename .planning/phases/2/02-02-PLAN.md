---
phase: 02-e2e-tests
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - tests/e2e/text-overlay.spec.js
  - tests/e2e/multi-note.spec.js
  - tests/e2e/clipboard.spec.js
  - tests/e2e/fixtures/test-image.png
autonomous: true

must_haves:
  truths:
    - "E2E test creates a text overlay, types content, and verifies it in the data model"
    - "E2E test creates multiple notes, navigates between them, and confirms each retains its content"
    - "E2E test pastes an image from clipboard and verifies it appears in the images array"
  artifacts:
    - path: "tests/e2e/text-overlay.spec.js"
      provides: "Text overlay creation and editing E2E test (TEST-04)"
      contains: "text-mode"
    - path: "tests/e2e/multi-note.spec.js"
      provides: "Multi-note navigation E2E test (TEST-05)"
      contains: "note-counter"
    - path: "tests/e2e/clipboard.spec.js"
      provides: "Clipboard paste E2E test (TEST-07)"
      contains: "clipboard"
    - path: "tests/e2e/fixtures/test-image.png"
      provides: "Small PNG fixture for clipboard paste test"
  key_links:
    - from: "tests/e2e/text-overlay.spec.js"
      to: "window.glassboardInstance.textItems"
      via: "page.evaluate to verify text in data model"
      pattern: "glassboardInstance\\.textItems"
    - from: "tests/e2e/multi-note.spec.js"
      to: "#pagination-island buttons"
      via: "page.click to navigate notes"
      pattern: "#new-note|#prev-note|#next-note"
    - from: "tests/e2e/clipboard.spec.js"
      to: "electronApp.evaluate for clipboard access"
      via: "nativeImage + clipboard.writeImage in main process"
      pattern: "clipboard\\.writeImage"
---

<objective>
Implement E2E tests for text overlays, multi-note navigation, and clipboard paste.

Purpose: Covers TEST-04 (text overlay), TEST-05 (multi-note), and TEST-07 (clipboard). These are independent user flows that don't require app restart, making them simpler than persistence tests.

Output: Three passing test files that verify text creation, note navigation, and clipboard paste against a real Electron instance.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/2/RESEARCH.md
@src/renderer.js
@src/index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Text overlay and multi-note navigation tests</name>
  <files>
    tests/e2e/text-overlay.spec.js
    tests/e2e/multi-note.spec.js
  </files>
  <action>
    1. Create `tests/e2e/text-overlay.spec.js`:
       - Import `{ test, expect }` from `./fixtures/electron-app`
       - Test: "create text overlay and verify content"
         - Click `#text-mode` to switch to text mode
         - Get `#text-container` boundingBox
         - Click at (box.x + 200, box.y + 200) to create a text item
         - Wait for `.text-item` to appear (the contenteditable div)
         - Type 'Hello E2E' via `page.keyboard.type('Hello E2E')`
         - Click elsewhere to deselect (click canvas area)
         - Verify via `page.evaluate(() => window.glassboardInstance.textItems.length)` is 1
         - Verify text content: `page.evaluate(() => window.glassboardInstance.textItems[0].content)` contains 'Hello E2E'
       - Test: "edit existing text overlay"
         - Create a text item (same as above with 'Initial text')
         - Click elsewhere to deselect
         - Switch to select mode (`#select-mode`)
         - Double-click the text item to re-enter edit mode
         - Select all (Cmd+A) and type 'Edited text'
         - Click elsewhere to deselect
         - Verify content changed in data model
       - Test: "multiple text overlays at different positions"
         - Switch to text mode
         - Create text at position (150, 150), type 'First'
         - Click elsewhere to deselect
         - Create text at position (300, 300), type 'Second'
         - Click elsewhere to deselect
         - Verify textItems.length === 2

       IMPORTANT: Text items in Floatnote are created by clicking `#text-container` (which overlays the canvas). The text input is a contenteditable div inside `.text-item`. After creating, the div is focused and ready for typing. The text content is stored as innerHTML in textItems[].content.

    2. Create `tests/e2e/multi-note.spec.js`:
       - Import `{ test, expect }` from `./fixtures/electron-app`
       - Helper: reuse `drawStroke` from drawing.spec.js or duplicate the helper inline
       - Test: "create new note and verify counter"
         - Verify initial counter text is '1/1' via `page.locator('#note-counter').textContent()`
         - Click `#new-note`
         - Verify counter shows '2/2'
       - Test: "navigate between notes preserves content"
         - Draw a stroke on note 1 (the initial note)
         - Click `#new-note` to create note 2
         - Verify counter is '2/2'
         - Draw a different stroke on note 2
         - Click `#prev-note` to go back to note 1
         - Verify counter is '1/2'
         - Verify lines on note 1: `page.evaluate(() => window.glassboardInstance.lines.length)` > 0
         - Click `#next-note` to go to note 2
         - Verify lines on note 2 > 0
       - Test: "new note starts empty"
         - Draw a stroke on note 1
         - Click `#new-note`
         - Verify lines.length === 0 on the new note
         - Verify textItems.length === 0 on the new note
       - Test: "navigate with keyboard shortcuts"
         - Create note 2 via `#new-note`
         - Press ']' to go forward (should stay on 2/2 since it's the last)
         - Press '[' to go back to note 1
         - Verify counter is '1/2'

       NOTE: The note counter element is `#note-counter` with text like "1/2". Navigation buttons are `#prev-note`, `#next-note`, `#new-note`. Keyboard shortcuts: '[' for prev, ']' for next, 'N' for new note. However, keyboard shortcuts may only work when not in text mode and no text item is focused.
  </action>
  <verify>
    Run `npx playwright test text-overlay.spec.js multi-note.spec.js` and all tests pass.
  </verify>
  <done>
    Text overlay tests verify creation, editing, and multiple items. Multi-note tests verify navigation, content isolation, and counter display. TEST-04 and TEST-05 satisfied.
  </done>
</task>

<task type="auto">
  <name>Task 2: Clipboard paste test with fixture image</name>
  <files>
    tests/e2e/clipboard.spec.js
    tests/e2e/fixtures/test-image.png
  </files>
  <action>
    1. Create `tests/e2e/fixtures/test-image.png`:
       Generate a small (50x50 pixel) solid-color PNG programmatically. Use Node.js to create it during test setup, or create a minimal valid PNG file.

       The simplest approach: create the PNG in the test itself using a known minimal PNG buffer. A 1x1 red pixel PNG is 67 bytes and can be stored as a Buffer literal. Or better: use a script to generate a small test PNG and commit it.

       Create a small script or just create the file inline in the fixture setup. The cleanest approach for the plan:
       - Create a 50x50 blue PNG using Node's Buffer with the raw PNG binary data
       - Write it to `tests/e2e/fixtures/test-image.png` as part of project setup
       - Use this approach: `node -e "..."` to generate it, or embed a minimal PNG as a base64 constant in the test

       PRACTICAL APPROACH: Generate the PNG in a setup step within the test file itself, or use a simple Node script. For simplicity, create the file using a `globalSetup` or a `beforeAll` that writes a minimal PNG to disk if it doesn't exist.

       SIMPLEST: Create a tiny valid PNG file directly. A minimal 1x1 PNG is exactly 67 bytes. Store it as a committed fixture file by running:
       ```javascript
       // Generate test-image.png (run once, commit the result)
       const fs = require('fs');
       const { execSync } = require('child_process');
       // Use ImageMagick or just write raw PNG bytes
       ```

       RECOMMENDED: Write a simple test setup that creates the file using Electron's nativeImage in the test itself, since we already have Electron available. No external fixture file needed.

    2. Create `tests/e2e/clipboard.spec.js`:
       - Import `{ test, expect }` from `./fixtures/electron-app`
       - Import `path`, `fs`
       - Test: "paste image from clipboard"
         - Use `electronApp.evaluate` to write an image to clipboard:
           ```javascript
           await electronApp.evaluate(async ({ clipboard, nativeImage }) => {
             // Create a small test image programmatically
             const img = nativeImage.createFromBuffer(
               Buffer.from(/* base64 of a small PNG */, 'base64')
             );
             clipboard.writeImage(img);
           });
           ```
           Use a minimal 10x10 red PNG base64 string (about 100 chars)
         - Trigger paste: `await page.keyboard.press('Meta+v')`
         - Wait for image to appear in data model:
           ```javascript
           await page.waitForFunction(() => {
             return window.glassboardInstance.images &&
                    window.glassboardInstance.images.length > 0;
           }, { timeout: 5000 });
           ```
         - Verify: `page.evaluate(() => window.glassboardInstance.images.length)` === 1

       - Test: "paste text from clipboard"
         - Use `electronApp.evaluate` to write text to clipboard:
           ```javascript
           await electronApp.evaluate(async ({ clipboard }) => {
             clipboard.writeText('Pasted from clipboard');
           });
           ```
         - Switch to text mode first: `await page.click('#text-mode')`
         - Trigger paste: `await page.keyboard.press('Meta+v')`
         - Wait for text to appear:
           ```javascript
           await page.waitForFunction(() => {
             return window.glassboardInstance.textItems &&
                    window.glassboardInstance.textItems.length > 0;
           }, { timeout: 5000 });
           ```
         - Verify text content contains 'Pasted from clipboard'

       NOTE: Check how the app handles paste. In renderer.js, paste is handled via `window.glassboard.onPaste` or a keyboard event listener. The preload exposes clipboard read. The paste handler checks for image first (via `readImage`), then falls back to text. Images are stored in `this.images` array as data URLs. Text paste may create a text item or paste into an existing focused text item.

       FALLBACK: If text paste behavior is complex (e.g., only works when a text item is focused), focus on the image paste test which is the primary TEST-07 requirement.
  </action>
  <verify>
    Run `npx playwright test clipboard.spec.js` and tests pass. At minimum the image paste test must pass.
  </verify>
  <done>
    Clipboard paste tests verify image paste creates an entry in the images array, and text paste creates/updates text content. TEST-07 satisfied.
  </done>
</task>

</tasks>

<verification>
- `npx playwright test text-overlay.spec.js` passes all text overlay tests
- `npx playwright test multi-note.spec.js` passes all navigation tests
- `npx playwright test clipboard.spec.js` passes clipboard tests
- All tests use the shared fixture (temp userData, dialog stubbing, cleanup)
- No test modifies files outside its temp directory
</verification>

<success_criteria>
- Text overlay: create, edit, multiple items all verified via data model (TEST-04)
- Multi-note: create, navigate, content isolation all verified (TEST-05)
- Clipboard: image paste verified via images array (TEST-07)
- `npx playwright test` runs all tests and exits 0
</success_criteria>

<output>
After completion, create `.planning/phases/2/02-02-SUMMARY.md`
</output>
