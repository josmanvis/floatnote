---
phase: 02-e2e-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - playwright.config.js
  - tests/e2e/fixtures/electron-app.js
  - tests/e2e/drawing.spec.js
  - src/main.js
  - src/renderer.js
  - package.json
autonomous: true

must_haves:
  truths:
    - "Running `npx playwright test drawing` launches real Electron app and draws a stroke"
    - "Drawing test verifies stroke data exists in the Glassboard instance after mouse events"
    - "Existing `npm test` (Jest) still passes unchanged"
  artifacts:
    - path: "playwright.config.js"
      provides: "Playwright test runner configuration for Electron"
      contains: "testDir.*tests/e2e"
    - path: "tests/e2e/fixtures/electron-app.js"
      provides: "Shared fixture: Electron launch with temp userData, dialog stubbing, cleanup"
      exports: ["test"]
    - path: "tests/e2e/drawing.spec.js"
      provides: "Drawing flow E2E test (TEST-03)"
      contains: "mouse.down"
  key_links:
    - from: "tests/e2e/fixtures/electron-app.js"
      to: "src/main.js"
      via: "electron.launch with args pointing to main.js"
      pattern: "electron\\.launch.*main\\.js"
    - from: "tests/e2e/drawing.spec.js"
      to: "window.glassboardInstance"
      via: "page.evaluate to read data model"
      pattern: "glassboardInstance\\.lines"
    - from: "src/main.js"
      to: "process.env.ELECTRON_USER_DATA_DIR"
      via: "app.setPath override for test isolation"
      pattern: "ELECTRON_USER_DATA_DIR"
---

<objective>
Set up Playwright for Electron E2E testing and implement the drawing flow test.

Purpose: Establishes the E2E test infrastructure that all subsequent test plans depend on. Without this, no E2E tests can run. Also delivers TEST-03 (drawing flow verification) as the first real test.

Output: Working `npx playwright test` that launches Floatnote, draws on the canvas, and verifies the stroke via the data model.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/2/RESEARCH.md
@src/main.js
@src/renderer.js
@src/index.html
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install deps and configure Playwright + app source modifications</name>
  <files>
    package.json
    playwright.config.js
    src/main.js
    src/renderer.js
  </files>
  <action>
    1. Install dev dependencies:
       `npm install --save-dev @playwright/test playwright electron-playwright-helpers`

    2. Add npm script to package.json:
       `"test:e2e": "npx playwright test"`

    3. Create `playwright.config.js` in project root:
       - testDir: './tests/e2e'
       - timeout: 30000
       - retries: process.env.CI ? 2 : 0
       - workers: 1 (required: single-instance lock prevents parallel)
       - reporter: process.env.CI ? 'github' : 'list'
       - use.trace: 'on-first-retry'
       - expect.toHaveScreenshot.maxDiffPixelRatio: 0.02

    4. Modify `src/main.js` - add BEFORE the `userDataPath` line (line 17):
       ```javascript
       // Allow E2E tests to override userData path for isolation
       if (process.env.ELECTRON_USER_DATA_DIR) {
         app.setPath('userData', process.env.ELECTRON_USER_DATA_DIR);
       }
       ```

    5. Modify `src/main.js` - wrap the single-instance lock (lines 21-24) in a test check:
       ```javascript
       if (process.env.NODE_ENV !== 'test') {
         const gotTheLock = app.requestSingleInstanceLock();
         if (!gotTheLock) {
           app.exit(0);
         }
       }
       ```
       Keep the `app.on('second-instance', ...)` handler unchanged.

    6. Modify `src/renderer.js` - change the DOMContentLoaded handler at the bottom (lines 3120-3123) to expose the instance:
       ```javascript
       // Initialize when DOM is ready
       document.addEventListener('DOMContentLoaded', () => {
           const glassboard = new Glassboard();
           // Expose instance for E2E testing (harmless in production - nothing reads it)
           window.glassboardInstance = glassboard;
       });
       ```
  </action>
  <verify>
    - `npm test` passes (existing Jest tests unaffected)
    - `node -e "require('./playwright.config.js')"` exits 0
    - `grep -q 'ELECTRON_USER_DATA_DIR' src/main.js` succeeds
    - `grep -q 'glassboardInstance' src/renderer.js` succeeds
  </verify>
  <done>
    Playwright config exists, app source supports test isolation via env vars, existing tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create shared Electron fixture and drawing flow test</name>
  <files>
    tests/e2e/fixtures/electron-app.js
    tests/e2e/drawing.spec.js
  </files>
  <action>
    1. Create `tests/e2e/fixtures/electron-app.js`:
       - Import `{ test: base, _electron: electron }` from `@playwright/test`
       - Import `{ stubDialog }` from `electron-playwright-helpers`
       - Import `path`, `fs`, `os`
       - Export a custom `test` fixture with:
         - `electronApp` fixture:
           - Creates temp dir via `fs.mkdtempSync(path.join(os.tmpdir(), 'floatnote-test-'))`
           - Launches Electron with `args: [path.join(__dirname, '../../../src/main.js')]`
           - env: `{ ...process.env, ELECTRON_USER_DATA_DIR: tmpDir, NODE_ENV: 'test' }`
           - Stubs close dialog: `await stubDialog(app, 'showMessageBox', { response: 0 })`
           - `await use(app)`
           - Cleanup: `await app.close()` then `fs.rmSync(tmpDir, { recursive: true, force: true })`
         - `page` fixture:
           - Gets `await electronApp.firstWindow()`
           - Waits for `#draw-canvas` selector
           - `await use(page)`
       - Export `expect` re-exported from `@playwright/test`

    2. Create `tests/e2e/drawing.spec.js`:
       - Import `{ test, expect }` from `./fixtures/electron-app`
       - Helper function `drawStroke(page, startX, startY, endX, endY)`:
         - Gets `#draw-canvas` boundingBox
         - `page.mouse.move(box.x + startX, box.y + startY)`
         - `page.mouse.down()`
         - Loop 10 steps with intermediate mouse.move calls
         - `page.mouse.up()`
       - Test: "draw a stroke and verify it exists in data model"
         - Click `#draw-mode` to ensure draw mode
         - Call `drawStroke(page, 100, 100, 300, 300)`
         - `page.evaluate(() => window.glassboardInstance.lines.length)` -> expect > 0
         - Also verify the line has points: `page.evaluate(() => window.glassboardInstance.lines[0].points.length)` -> expect > 2
       - Test: "draw multiple strokes"
         - Draw two separate strokes
         - Verify line count is 2 (note: strokes within 500ms may be grouped by objectId, so add a small delay between them or verify total points across all lines > threshold)
       - Test: "undo removes last stroke"
         - Draw a stroke, verify lines > 0
         - Press Cmd+Z: `await page.keyboard.press('Meta+z')`
         - Verify lines is 0
       - Test: "clear all removes everything"
         - Draw a stroke
         - Click `#clear-btn`
         - Handle the clear confirmation if any (check if dialog appears)
         - Verify lines is 0

    IMPORTANT: The `lines` getter on Glassboard accesses `this.notes[this.currentNoteIndex].lines`. This means `window.glassboardInstance.lines` returns the current note's lines. Similarly for `textItems` and `images`.
  </action>
  <verify>
    Run `npx playwright test drawing.spec.js` and all tests pass. Expected: 4 tests pass (draw stroke, multiple strokes, undo, clear).
  </verify>
  <done>
    `npx playwright test drawing` runs all drawing E2E tests against a real Electron instance, verifying strokes via the data model. TEST-03 is satisfied.
  </done>
</task>

</tasks>

<verification>
- `npm test` passes (Jest integration/unit tests unchanged)
- `npx playwright test` runs all E2E tests in tests/e2e/
- Drawing tests launch real Electron, draw on canvas, verify data model
- App launches with temp userData dir and cleans up after
- No hardcoded paths or flaky waits (uses boundingBox, explicit selectors)
</verification>

<success_criteria>
- `npx playwright test drawing.spec.js` exits 0 with all tests passing
- `npm test` exits 0 (existing tests unbroken)
- Playwright config, fixture, and test file all exist
- src/main.js respects ELECTRON_USER_DATA_DIR and NODE_ENV=test
- src/renderer.js exposes window.glassboardInstance
</success_criteria>

<output>
After completion, create `.planning/phases/2/02-01-SUMMARY.md`
</output>
