---
phase: 04-npm-publishing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [package.json]
autonomous: true

must_haves:
  truths:
    - "npm pack --dry-run shows only bin/floatnote.js, package.json, README.md, and LICENSE"
    - "Package size reported by npm pack --dry-run is under 10KB"
    - "npm publish locally would run tests first via prepublishOnly"
    - "npm start and npm run dev still launch the Electron app correctly"
    - "node bin/floatnote.js --version prints the package version"
  artifacts:
    - path: "package.json"
      provides: "npm publishing configuration with files whitelist and prepublishOnly hook"
      contains: "\"files\""
  key_links:
    - from: "package.json files field"
      to: "bin/"
      via: "npm pack includes only whitelisted paths"
      pattern: "\"files\".*\"bin/\""
    - from: "package.json prepublishOnly"
      to: "npm test"
      via: "lifecycle hook gates publishing on test passage"
      pattern: "\"prepublishOnly\".*\"npm test\""
    - from: "bin/floatnote.js"
      to: "package.json version"
      via: "CLI reads version from package.json"
      pattern: "require.*package\\.json"
---

<objective>
Configure package.json so that npm publishes only the bin/ directory (~7KB CLI script) and gates publishing on passing tests. Validate the CLI script works end-to-end in isolation.

Purpose: The npm package must be minimal (under 10KB) since it is only a CLI launcher that downloads the real app from GitHub Releases. The `main` field currently causes src/main.js to leak into the tarball, violating the size constraint. The CLI script must work correctly since it is the entry point for `npx floatnote`.

Output: A package.json that passes `npm pack --dry-run` verification (bin-only, under 10KB) while keeping `electron .` functional for local development, and a verified CLI script.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/4/RESEARCH.md
@package.json
@bin/floatnote.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure package.json for bin-only publishing</name>
  <files>package.json</files>
  <action>
Make three changes to package.json:

1. Remove the `"main": "src/main.js"` field entirely. This prevents src/main.js from being included in the npm tarball (npm always includes the main entry regardless of the files whitelist).

2. Add `"files": ["bin/"]` at the top level. This restricts the published tarball to only bin/ contents (plus always-included package.json, README, LICENSE).

3. Add `"prepublishOnly": "npm test"` to the scripts section. This lifecycle hook runs tests before any npm publish attempt, gating publishing on test passage.

4. Update the `"start"` script from `"electron ."` to `"electron src/main.js"` and the `"dev"` script from `"electron . --enable-logging"` to `"electron src/main.js --enable-logging"`. This is necessary because `electron .` relies on the `main` field in package.json to find the entry point, and we are removing that field. Passing the entry file directly to electron is equivalent and does not require the main field.

Do NOT add any new dependencies. Do NOT modify the bin field, build config, or any other fields.
  </action>
  <verify>
Run these commands and verify:

1. `npm pack --dry-run 2>&1` - Output should show ONLY:
   - bin/floatnote.js
   - package.json
   - (README.md and/or LICENSE if they exist)
   - NO src/ files, NO tests/, NO other directories
   - Total package size should be reported under 10KB

2. `npm run start -- --version 2>&1 || true` - Verify the start script still references electron correctly (may fail if electron not in PATH but command should show `electron src/main.js`)

3. `node -e "const p = require('./package.json'); console.log('files:', p.files); console.log('prepublishOnly:', p.scripts.prepublishOnly); console.log('main:', p.main);"` - Should show files: ["bin/"], prepublishOnly: "npm test", main: undefined
  </verify>
  <done>
npm pack --dry-run shows only bin/floatnote.js and package.json (plus README/LICENSE), total size under 10KB. The prepublishOnly script is set to "npm test". The start/dev scripts use explicit entry point path instead of relying on main field.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify tests pass and CLI script works end-to-end</name>
  <files>package.json</files>
  <action>
Run the full verification suite to confirm the npm publishing pipeline works:

1. Run `npm test` and confirm all tests pass with exit code 0. Tests MUST pass -- this is what prepublishOnly will execute before any npm publish.

2. Run `npm pack --dry-run` and parse the output to verify:
   - Package size is under 10KB
   - Only expected files are included (bin/floatnote.js, package.json, README.md, LICENSE)
   - No src/, tests/, node_modules/, or other dev files leak in

3. Run `npm pack` to create the actual tarball, then inspect it:
   - `tar tzf floatnote-*.tgz` to list contents
   - Verify only package/bin/floatnote.js and package/package.json (plus README/LICENSE)
   - Delete the .tgz file after verification

4. Verify the CLI script works in isolation (NPM-05 coverage):
   - `node bin/floatnote.js --version` should print the version from package.json
   - `node bin/floatnote.js --help` should print usage info
   - These validate that `npx floatnote` would invoke a working script (the full npx flow requires published GitHub Releases from Phase 3, but the CLI script itself must be functional)

If npm pack shows unexpected files, investigate which package.json field is causing the inclusion and fix it.
  </action>
  <verify>
1. `npm test` exits with code 0 (required, not optional)
2. `npm pack --dry-run` shows package size under 10KB and only bin/ files
3. `tar tzf floatnote-*.tgz` shows only package/bin/floatnote.js, package/package.json, and optionally README/LICENSE
4. `node bin/floatnote.js --version` outputs version string matching package.json version
5. `node bin/floatnote.js --help` outputs usage information
6. The .tgz file is cleaned up after verification
  </verify>
  <done>
Tests pass (exit 0), tarball contains only the CLI script and metadata files, total package size is under 10KB, and the bin script executes correctly in isolation (`--version` and `--help` work). The package is ready for npm publish and the CLI entry point for `npx floatnote` is verified functional.
  </done>
</task>

</tasks>

<verification>
- `npm pack --dry-run` output shows only bin/floatnote.js, package.json, and auto-included files
- Package size under 10KB
- `npm test` passes (prepublishOnly gate would succeed)
- `node bin/floatnote.js --version` works correctly (NPM-05 CLI validation)
- `node bin/floatnote.js --help` works correctly
- npm start/dev scripts still reference the correct electron entry point
</verification>

<success_criteria>
1. package.json has no `main` field, has `"files": ["bin/"]`, and has `"prepublishOnly": "npm test"` in scripts
2. npm pack --dry-run confirms package size under 10KB with only bin/ contents
3. All existing tests pass (exit code 0)
4. The bin script executes correctly: `--version` prints version, `--help` prints usage
</success_criteria>

<output>
After completion, create `.planning/phases/4/04-01-SUMMARY.md`
</output>
