---
phase: 04-npm-publishing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [.github/workflows/release.yml]
autonomous: true
user_setup:
  - service: npm
    why: "npm registry authentication for automated publishing"
    env_vars:
      - name: NPM_TOKEN
        source: "npmjs.com -> Settings -> Access Tokens -> Generate New Token (Granular) -> Package: floatnote, Permissions: Read and write"
    dashboard_config:
      - task: "Add NPM_TOKEN as repository secret"
        location: "GitHub repo -> Settings -> Secrets and variables -> Actions -> New repository secret"

must_haves:
  truths:
    - "A successful GitHub Release triggers npm publish automatically"
    - "npm publish authenticates using NPM_TOKEN secret"
    - "npm publish runs on ubuntu-latest (no macOS needed for bin-only package)"
    - "The workflow file is structured so Phase 3 can add build/release jobs alongside publish-npm"
  artifacts:
    - path: ".github/workflows/release.yml"
      provides: "publish-npm job that publishes to npm registry on release events"
      contains: "publish-npm"
  key_links:
    - from: ".github/workflows/release.yml publish-npm job"
      to: "npm registry"
      via: "npm publish with NODE_AUTH_TOKEN"
      pattern: "NODE_AUTH_TOKEN.*NPM_TOKEN"
    - from: ".github/workflows/release.yml trigger"
      to: "GitHub Release events"
      via: "on release published"
      pattern: "release.*published"
---

<objective>
Create the release workflow file with a publish-npm job so that GitHub Releases trigger automatic npm publishing.

Purpose: Phase 3 has not yet executed, so `.github/workflows/release.yml` does not exist. This plan creates the workflow file with the npm publishing job and a trigger on release events. Phase 3 will later add build and release jobs to this same file, and once those exist, publish-npm can be updated to depend on them via `needs`.

Output: A `.github/workflows/release.yml` file with the publish-npm job, triggered by release published events, ready for Phase 3 to extend with build jobs.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/4/RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create release workflow with publish-npm job</name>
  <files>.github/workflows/release.yml</files>
  <action>
Create the file `.github/workflows/release.yml` (and the `.github/workflows/` directory if it doesn't exist).

The workflow should contain:

1. Name: `Release and Publish`

2. Trigger: `on: release: types: [published]` -- fires when a GitHub Release is published (not on drafts).

3. A single job `publish-npm` that publishes the package to npm:
   - runs-on: ubuntu-latest
   - Steps:
     a. `actions/checkout@v4`
     b. `actions/setup-node@v4` with `node-version: '20'` and `registry-url: 'https://registry.npmjs.org'` (registry-url is CRITICAL for auth to work)
     c. `npm publish` with env `NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}`

4. Add a YAML comment above the publish-npm job explaining the Phase 3 relationship:
   ```
   # Phase 3 will add build and release jobs above this job.
   # Once those exist, add `needs: [release]` to publish-npm
   # so npm publish only runs after artifacts are uploaded.
   ```

The complete file content:

```yaml
name: Release and Publish

on:
  release:
    types: [published]

jobs:
  # Phase 3 will add build and release jobs above this job.
  # Once those exist, add `needs: [release]` to publish-npm
  # so npm publish only runs after artifacts are uploaded.
  publish-npm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
      - run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
```

Do NOT add any other jobs. Do NOT add build steps or macOS runners. Phase 3 owns the build/release pipeline.
  </action>
  <verify>
1. File exists: `ls .github/workflows/release.yml`
2. Valid YAML: `node -e "const fs=require('fs'); const content=fs.readFileSync('.github/workflows/release.yml','utf8'); console.log('Valid, length:', content.length)"`
3. Contains trigger: `grep 'types:.*published' .github/workflows/release.yml`
4. Contains publish-npm job: `grep 'publish-npm' .github/workflows/release.yml`
5. Contains registry-url: `grep 'registry-url' .github/workflows/release.yml`
6. Contains NPM_TOKEN reference: `grep 'NPM_TOKEN' .github/workflows/release.yml`
7. Contains Phase 3 comment: `grep 'Phase 3' .github/workflows/release.yml`
8. Does NOT contain `needs:` (since no release job exists yet): `grep -c 'needs:' .github/workflows/release.yml` should be 0
  </verify>
  <done>
`.github/workflows/release.yml` exists with a publish-npm job triggered by release published events. The job authenticates with NPM_TOKEN and publishes to npm registry. A comment documents that Phase 3 will add build jobs and the `needs` dependency.
  </done>
</task>

<task type="auto">
  <name>Task 2: Validate workflow structure and cross-check with package.json</name>
  <files>.github/workflows/release.yml</files>
  <action>
Validate the workflow is correct and will function properly:

1. Parse the YAML to verify structure:
   - `node -e "const fs=require('fs'); const lines=fs.readFileSync('.github/workflows/release.yml','utf8').split('\\n'); lines.forEach((l,i)=>console.log(i+1,l))"` to inspect full content
   - Verify indentation is correct (YAML is whitespace-sensitive)

2. Verify the workflow trigger is correct:
   - `on: release: types: [published]` fires on published releases only
   - This means: manual releases via GitHub UI, or releases created by Phase 3's workflow

3. Verify the publish-npm job structure:
   - Uses ubuntu-latest (not macOS -- no native build needed for bin-only package)
   - setup-node has BOTH node-version AND registry-url (both required)
   - npm publish uses NODE_AUTH_TOKEN env var (not NPM_TOKEN directly -- GitHub Actions convention)

4. Cross-check with package.json:
   - If plan 04-01 has already run: verify package.json has `"files": ["bin/"]` and `"prepublishOnly": "npm test"`
   - If plan 04-01 has not run yet: just note these are prerequisites and will be configured by plan 04-01
   - The combination ensures npm publish will: run tests first (prepublishOnly), then publish only bin/ (files field)

If any issues found (bad indentation, missing fields), fix them in the workflow file.
  </action>
  <verify>
1. `.github/workflows/release.yml` is syntactically valid YAML with correct indentation
2. The workflow triggers on `release: types: [published]` events only
3. The publish-npm job does NOT have a `needs` field (no release job exists yet)
4. The NODE_AUTH_TOKEN uses correct secrets syntax: `${{ secrets.NPM_TOKEN }}`
5. The registry-url is set to `https://registry.npmjs.org`
  </verify>
  <done>
The release workflow is correctly structured: triggers on published releases, publish-npm job authenticates with NPM_TOKEN via NODE_AUTH_TOKEN, uses setup-node with registry-url. The workflow is ready to function independently now (publishing on any manual release) and ready for Phase 3 to extend with build/release jobs.
  </done>
</task>

</tasks>

<verification>
- `.github/workflows/release.yml` exists and contains a valid publish-npm job
- Job does NOT have `needs` (no release job exists yet -- Phase 3 adds it)
- Job runs on ubuntu-latest with Node 20
- Registry URL is set to https://registry.npmjs.org
- NODE_AUTH_TOKEN references secrets.NPM_TOKEN
- Workflow triggers on release published events
- Comment documents Phase 3 integration point
</verification>

<success_criteria>
1. The release workflow file exists with a publish-npm job triggered by release published events
2. The job authenticates with npm using NPM_TOKEN secret via NODE_AUTH_TOKEN env var
3. The job uses actions/setup-node with registry-url configured (required for auth)
4. The workflow YAML is syntactically valid with correct indentation
5. A comment explains that Phase 3 will add build jobs and the `needs` dependency
</success_criteria>

<output>
After completion, create `.planning/phases/4/04-02-SUMMARY.md`
</output>
