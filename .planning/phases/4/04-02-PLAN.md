---
phase: 04-npm-publishing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [.github/workflows/release.yml]
autonomous: true
user_setup:
  - service: npm
    why: "npm registry authentication for automated publishing"
    env_vars:
      - name: NPM_TOKEN
        source: "npmjs.com -> Settings -> Access Tokens -> Generate New Token (Granular) -> Package: floatnote, Permissions: Read and write"
    dashboard_config:
      - task: "Add NPM_TOKEN as repository secret"
        location: "GitHub repo -> Settings -> Secrets and variables -> Actions -> New repository secret"

must_haves:
  truths:
    - "A successful GitHub Release triggers npm publish automatically"
    - "npm publish authenticates using NPM_TOKEN secret"
    - "npm publish only runs after the release job succeeds"
    - "npm publish runs on ubuntu-latest (no macOS needed for bin-only package)"
  artifacts:
    - path: ".github/workflows/release.yml"
      provides: "publish-npm job that publishes to npm registry after release"
      contains: "publish-npm"
  key_links:
    - from: ".github/workflows/release.yml publish-npm job"
      to: "npm registry"
      via: "npm publish with NODE_AUTH_TOKEN"
      pattern: "NODE_AUTH_TOKEN.*NPM_TOKEN"
    - from: "publish-npm job"
      to: "release job"
      via: "needs dependency"
      pattern: "needs:.*release"
---

<objective>
Add an npm publish job to the existing release workflow so that every successful GitHub Release automatically publishes the CLI package to npm.

Purpose: After Phase 3's release workflow creates a GitHub Release with macOS app artifacts, this job publishes the lightweight CLI package to npm, making `npx floatnote` work for end users.

Output: A `publish-npm` job in the release workflow that authenticates with NPM_TOKEN and runs `npm publish` on ubuntu-latest.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/4/RESEARCH.md
@.github/workflows/release.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add publish-npm job to release workflow</name>
  <files>.github/workflows/release.yml</files>
  <action>
Read the existing `.github/workflows/release.yml` (created by Phase 3). Add a `publish-npm` job that runs after the release job completes successfully.

The job should:

1. Use `needs: [release]` (or whatever the release job is named in the existing workflow - read the file to find the job name). This ensures npm publish only happens after artifacts are uploaded and the GitHub Release is finalized.

2. Run on `ubuntu-latest` (not macOS - we only need to publish the bin/ directory, no native build required).

3. Steps:
   a. `actions/checkout@v4` - check out the repo
   b. `actions/setup-node@v4` with `node-version: '20'` and `registry-url: 'https://registry.npmjs.org'` - the registry-url is CRITICAL as it creates the .npmrc file with auth configuration
   c. `npm publish` with env `NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}` - publishes the package

The complete job block to add:

```yaml
  publish-npm:
    needs: [RELEASE_JOB_NAME]  # Replace with actual job name from the workflow
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
      - run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
```

IMPORTANT: Read the existing workflow file first to identify the correct job name for the `needs` field. The Phase 3 workflow likely has a job named `release` or `build-and-release` or similar.

If the release workflow does NOT yet exist (Phase 3 not executed), create the minimal workflow file with:
- Trigger: `on: release: types: [published]`
- Single job: `publish-npm` (without `needs` since there's no prior job yet)

Do NOT modify any existing jobs in the workflow. Only ADD the publish-npm job.
Do NOT skip the registry-url parameter (without it, auth will fail silently).
  </action>
  <verify>
1. The workflow file is valid YAML: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/release.yml'))"` or `node -e "const fs=require('fs'); console.log('valid')"` (basic syntax check)

2. The publish-npm job exists and has correct structure:
   - `grep -A 15 "publish-npm" .github/workflows/release.yml` shows the full job
   - Contains `registry-url: 'https://registry.npmjs.org'`
   - Contains `NODE_AUTH_TOKEN`
   - Contains `needs:` referencing the release job (if it exists)

3. The workflow trigger includes `release: types: [published]`
  </verify>
  <done>
The release workflow contains a publish-npm job that: depends on the release job, runs on ubuntu-latest, sets up Node 20 with npm registry auth, and runs npm publish with NPM_TOKEN. The workflow trigger fires on published releases (not drafts).
  </done>
</task>

<task type="auto">
  <name>Task 2: Validate complete publishing pipeline configuration</name>
  <files>.github/workflows/release.yml</files>
  <action>
Perform end-to-end validation of the entire npm publishing pipeline configuration:

1. Verify workflow YAML is syntactically valid by parsing it:
   `node -e "const fs = require('fs'); const yaml = require('yaml') || null; const content = fs.readFileSync('.github/workflows/release.yml', 'utf8'); console.log('File readable, length:', content.length)"`
   If yaml module not available, just verify the file is readable and well-structured.

2. Verify the publish-npm job references are consistent:
   - The `needs` field references a job that actually exists in the workflow
   - The trigger `on: release: types: [published]` exists (either at top level or the workflow already has it from Phase 3)

3. Cross-check with package.json configuration (from plan 04-01):
   - Verify package.json has `"files": ["bin/"]` (if 04-01 already ran)
   - Verify package.json has `"prepublishOnly": "npm test"` (if 04-01 already ran)
   - If 04-01 hasn't run yet, just note these are expected prerequisites

4. Document the full publishing flow in a comment at the end of the verification:
   - Tag push -> Phase 3 builds macOS app -> Creates GitHub Release -> Triggers publish-npm -> npm publish -> Package on registry -> `npx floatnote` works

If the workflow has issues (missing trigger, invalid YAML, broken job references), fix them.
  </action>
  <verify>
1. `.github/workflows/release.yml` is syntactically valid YAML
2. The publish-npm job's `needs` references an existing job in the same workflow
3. The workflow will trigger on `release: types: [published]` events
4. The NODE_AUTH_TOKEN uses the correct secrets syntax: `${{ secrets.NPM_TOKEN }}`
  </verify>
  <done>
The complete npm publishing pipeline is configured: release workflow triggers on published releases, the publish-npm job waits for the release job, authenticates with NPM_TOKEN, and publishes the bin-only package to npm. The pipeline is ready to function once NPM_TOKEN is configured as a repository secret.
  </done>
</task>

</tasks>

<verification>
- `.github/workflows/release.yml` contains a valid publish-npm job
- Job uses `needs` to depend on the release job
- Job runs on ubuntu-latest with Node 20
- Registry URL is set to https://registry.npmjs.org
- NODE_AUTH_TOKEN references secrets.NPM_TOKEN
- Workflow triggers on release published events
</verification>

<success_criteria>
1. The release workflow has a publish-npm job that runs after successful GitHub Release creation
2. The job authenticates with npm using NPM_TOKEN secret via NODE_AUTH_TOKEN env var
3. The job uses actions/setup-node with registry-url configured (required for auth)
4. The workflow YAML is syntactically valid
</success_criteria>

<output>
After completion, create `.planning/phases/4/04-02-SUMMARY.md`
</output>
