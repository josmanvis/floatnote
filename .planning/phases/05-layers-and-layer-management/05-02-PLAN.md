---
phase: 05-layers-and-layer-management
plan: 02
type: execute
wave: 2
depends_on: [05-01]
files_modified: [src/index.html, src/styles.css, src/renderer.js]
autonomous: true

must_haves:
  truths:
    - "Users can create, rename, and delete layers from a minimal layer panel"
    - "Layers can be reordered with up/down controls, rendering order matches layer order"
    - "Individual layers can be hidden/shown via visibility toggle"
    - "Individual layers can be locked via lock toggle"
    - "Active layer is visually highlighted in the panel"
    - "Layer panel can be toggled open/closed"
  artifacts:
    - path: "src/index.html"
      provides: "Layer panel HTML structure and layer toggle button in toolbar"
      contains: "layer-panel|layer-toggle"
    - path: "src/styles.css"
      provides: "Layer panel glassmorphism styling, layer item layout, icon styles"
      contains: "layer-panel|layer-item|layer-visibility"
    - path: "src/renderer.js"
      provides: "Layer panel logic: create, rename, delete, reorder, toggle visibility/lock"
      contains: "updateLayerPanel|createLayer|deleteLayer|moveLayerUp|moveLayerDown|toggleLayerVisibility|toggleLayerLock"
  key_links:
    - from: "layer panel UI"
      to: "note.layers array"
      via: "updateLayerPanel() renders current layer state"
      pattern: "updateLayerPanel"
    - from: "visibility toggle"
      to: "redraw() + updateDOMVisibility()"
      via: "toggleLayerVisibility sets layer.visible and redraws"
      pattern: "toggleLayerVisibility"
    - from: "reorder buttons"
      to: "note.layers array order"
      via: "splice operations on layers array"
      pattern: "moveLayer(Up|Down)"
---

<objective>
Build the layer panel UI (collapsible left-side panel with glassmorphism), layer toolbar button, and all layer management operations: create, rename, delete, reorder, toggle visibility, toggle lock. Wire panel updates to all layer state changes.

Purpose: Users need a visible, minimal interface to manage layers. This plan provides the UI and interaction logic that controls the data model from Plan 01.
Output: A functional layer panel accessible via toolbar button or keyboard shortcut (L), with all layer operations working.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-layers-and-layer-management/05-RESEARCH.md
@.planning/phases/05-layers-and-layer-management/05-01-SUMMARY.md
@src/renderer.js
@src/index.html
@src/styles.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Layer panel HTML and CSS</name>
  <files>src/index.html, src/styles.css</files>
  <action>
1. Add a layer toggle button to the left toolbar (`#size-toolbar`), after the freeze button:
   ```html
   <button id="layer-toggle" class="tool-btn" title="Layers (L)">
       <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
           <polygon points="12 2 2 7 12 12 22 7 12 2"/>
           <polyline points="2 17 12 22 22 17"/>
           <polyline points="2 12 12 17 22 12"/>
       </svg>
   </button>
   ```

2. Add the layer panel HTML inside `#app`, after the `#settings-panel` div (before the closing `</div>` of app):
   ```html
   <!-- Layer panel -->
   <div id="layer-panel" class="layer-panel">
       <div class="layer-panel-header">
           <span class="layer-panel-title">Layers</span>
           <button id="add-layer-btn" class="layer-action-btn" title="Add layer">
               <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor">
                   <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
               </svg>
           </button>
       </div>
       <div class="layer-list" id="layer-list">
           <!-- Layer items rendered dynamically by updateLayerPanel() -->
       </div>
   </div>
   ```

3. Add keyboard shortcut entry in the shortcuts list in settings:
   ```html
   <div class="shortcut-item">
       <span>Layers panel</span><kbd>L</kbd>
   </div>
   ```

4. Add CSS for the layer panel in `src/styles.css`:

   ```css
   /* Layer Panel */
   .layer-panel {
       position: absolute;
       left: 12px;
       top: 60px;
       bottom: 60px;
       width: 180px;
       max-height: calc(100vh - 120px);
       background: rgba(30, 30, 30, 0.95);
       backdrop-filter: blur(20px) saturate(180%);
       -webkit-backdrop-filter: blur(20px) saturate(180%);
       border-radius: 12px;
       border: 1px solid rgba(255, 255, 255, 0.1);
       box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
       z-index: 90;
       opacity: 0;
       visibility: hidden;
       transform: translateX(-10px);
       transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
       display: flex;
       flex-direction: column;
       pointer-events: auto;
   }

   .layer-panel.visible {
       opacity: 1;
       visibility: visible;
       transform: translateX(0);
   }

   .drawing .layer-panel {
       pointer-events: none;
   }

   .layer-panel-header {
       display: flex;
       align-items: center;
       justify-content: space-between;
       padding: 10px 12px 8px;
       border-bottom: 1px solid rgba(255, 255, 255, 0.08);
   }

   .layer-panel-title {
       font-size: 11px;
       font-weight: 600;
       text-transform: uppercase;
       letter-spacing: 0.5px;
       color: rgba(255, 255, 255, 0.6);
   }

   .layer-action-btn {
       background: none;
       border: none;
       color: rgba(255, 255, 255, 0.6);
       cursor: pointer;
       padding: 4px;
       border-radius: 4px;
       display: flex;
       align-items: center;
       justify-content: center;
       transition: color 0.15s, background 0.15s;
   }

   .layer-action-btn:hover {
       color: #fff;
       background: rgba(255, 255, 255, 0.1);
   }

   .layer-list {
       flex: 1;
       overflow-y: auto;
       padding: 6px;
   }

   .layer-list::-webkit-scrollbar {
       width: 4px;
   }

   .layer-list::-webkit-scrollbar-thumb {
       background: rgba(255, 255, 255, 0.2);
       border-radius: 2px;
   }

   .layer-item {
       display: flex;
       align-items: center;
       gap: 4px;
       padding: 5px 6px;
       border-radius: 6px;
       cursor: pointer;
       transition: background 0.15s ease;
       margin-bottom: 2px;
       position: relative;
   }

   .layer-item:hover {
       background: rgba(255, 255, 255, 0.08);
   }

   .layer-item.active {
       background: rgba(59, 130, 246, 0.15);
       border: 1px solid rgba(59, 130, 246, 0.3);
   }

   .layer-item.hidden-layer {
       opacity: 0.4;
   }

   .layer-item.locked-layer {
       opacity: 0.7;
   }

   .layer-icon-btn {
       background: none;
       border: none;
       color: rgba(255, 255, 255, 0.5);
       cursor: pointer;
       padding: 2px;
       border-radius: 3px;
       display: flex;
       align-items: center;
       justify-content: center;
       flex-shrink: 0;
       width: 20px;
       height: 20px;
       transition: color 0.15s;
   }

   .layer-icon-btn:hover {
       color: #fff;
   }

   .layer-icon-btn.active {
       color: rgba(59, 130, 246, 0.8);
   }

   .layer-name {
       flex: 1;
       font-size: 12px;
       color: rgba(255, 255, 255, 0.85);
       white-space: nowrap;
       overflow: hidden;
       text-overflow: ellipsis;
       min-width: 0;
       padding: 1px 4px;
       border-radius: 3px;
       border: 1px solid transparent;
       outline: none;
   }

   .layer-name.editing {
       border-color: rgba(59, 130, 246, 0.5);
       background: rgba(0, 0, 0, 0.3);
       color: #fff;
   }

   .layer-order-btns {
       display: flex;
       flex-direction: column;
       gap: 0;
       flex-shrink: 0;
   }

   .layer-order-btn {
       background: none;
       border: none;
       color: rgba(255, 255, 255, 0.4);
       cursor: pointer;
       padding: 0;
       width: 14px;
       height: 10px;
       display: flex;
       align-items: center;
       justify-content: center;
       font-size: 8px;
       transition: color 0.15s;
   }

   .layer-order-btn:hover {
       color: #fff;
   }

   .layer-delete-btn {
       background: none;
       border: none;
       color: rgba(255, 255, 255, 0.3);
       cursor: pointer;
       padding: 2px;
       border-radius: 3px;
       display: none;
       align-items: center;
       justify-content: center;
       flex-shrink: 0;
       width: 18px;
       height: 18px;
       font-size: 10px;
       transition: color 0.15s;
   }

   .layer-item:hover .layer-delete-btn {
       display: flex;
   }

   .layer-delete-btn:hover {
       color: #ef4444;
   }
   ```

  </action>
  <verify>
Open the HTML file in a browser (or run the app) and verify the layer panel structure exists in the DOM. Check that the CSS file has no syntax errors by running `npx prettier --check src/styles.css` (or manual inspection).
  </verify>
  <done>
- Layer toggle button exists in left toolbar
- Layer panel HTML exists (hidden by default)
- Layer panel styled with glassmorphism matching existing UI
- Panel has header with title and add button
- Layer items have visibility, name, lock, order, and delete controls
- Panel becomes pointer-events: none during drawing
  </done>
</task>

<task type="auto">
  <name>Task 2: Layer panel JavaScript logic and keyboard shortcut</name>
  <files>src/renderer.js</files>
  <action>
1. In the constructor, add layer panel state:
   ```javascript
   this.layerPanelVisible = false;
   ```

2. In `init()`, add `this.setupLayerPanel();` call after `this.setupPagination();`

3. Add `setupLayerPanel()` method:
   ```javascript
   setupLayerPanel() {
       const toggleBtn = document.getElementById('layer-toggle');
       const panel = document.getElementById('layer-panel');
       const addBtn = document.getElementById('add-layer-btn');

       if (toggleBtn) {
           toggleBtn.addEventListener('click', () => this.toggleLayerPanel());
       }

       if (addBtn) {
           addBtn.addEventListener('click', () => this.createLayer());
       }

       // Initial render
       this.updateLayerPanel();
   }
   ```

4. Add `toggleLayerPanel()` method:
   ```javascript
   toggleLayerPanel() {
       this.layerPanelVisible = !this.layerPanelVisible;
       const panel = document.getElementById('layer-panel');
       if (panel) {
           panel.classList.toggle('visible', this.layerPanelVisible);
       }
       const toggleBtn = document.getElementById('layer-toggle');
       if (toggleBtn) {
           toggleBtn.classList.toggle('active', this.layerPanelVisible);
       }
   }
   ```

5. Add `createLayer(name)` method:
   ```javascript
   createLayer(name) {
       const note = this.notes[this.currentNoteIndex];
       if (!note || !note.layers) return;

       const newLayer = {
           id: 'layer-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
           name: name || 'Layer ' + (note.layers.length + 1),
           visible: true,
           locked: false,
           lines: [],
           textItems: [],
           images: []
       };
       note.layers.push(newLayer);
       note.activeLayerId = newLayer.id;
       this.saveState();
       this.updateLayerPanel();
       this.redraw();
   }
   ```

6. Add `deleteLayer(layerId)` method:
   - Don't allow deleting if only 1 layer remains
   - Remove the layer from the array
   - If deleted layer was active, set active to the first remaining layer
   - Remove DOM elements with matching data-layer-id
   - Call saveState(), updateLayerPanel(), redraw()

7. Add `renameLayer(layerId, newName)` method:
   - Find layer by ID, set layer.name = newName (trim, default to old name if empty)
   - Call autoSave()

8. Add `moveLayerUp(layerId)` method:
   - Find index of layer. If already last (top), do nothing
   - Swap with element at index + 1 (moving up means higher rendering order = later in array)
   - Call saveState(), updateLayerPanel(), redraw()

9. Add `moveLayerDown(layerId)` method:
   - Find index of layer. If already first (bottom), do nothing
   - Swap with element at index - 1
   - Call saveState(), updateLayerPanel(), redraw()

10. Add `setActiveLayer(layerId)` method:
    - Set `note.activeLayerId = layerId`
    - Call updateLayerPanel()

11. Add `toggleLayerVisibility(layerId)` method:
    - Find layer, toggle `layer.visible`
    - If hiding the active layer, switch active to next visible layer (or first visible)
    - Call updateDOMVisibility(), redraw(), updateLayerPanel()

12. Add `toggleLayerLock(layerId)` method:
    - Find layer, toggle `layer.locked`
    - Call updateLayerPanel()

13. Add `updateLayerPanel()` method:
    - Gets the layer list container (`#layer-list`)
    - Clears its innerHTML
    - Iterates `note.layers` in REVERSE order (top layer shown at top of panel, which is the last in the array)
    - For each layer, create a div with class `layer-item` (add `.active` if it's the active layer, `.hidden-layer` if not visible, `.locked-layer` if locked)
    - Inside each item:
      a. Visibility button (eye SVG): open eye if visible, closed eye if hidden. Click calls toggleLayerVisibility
      b. Name span (class `layer-name`): double-click to make contenteditable for renaming, blur/enter to save
      c. Lock button (lock SVG): open if unlocked, closed if locked. Click calls toggleLayerLock
      d. Order buttons container: up arrow (calls moveLayerUp), down arrow (calls moveLayerDown)
      e. Delete button (x): click calls deleteLayer (only if more than 1 layer)
    - Clicking the layer item itself (not buttons) calls setActiveLayer

14. Add keyboard shortcut for toggling layer panel:
    - In setupKeyboardShortcuts(), add case for 'l' key (when not in text editing): call `this.toggleLayerPanel()`

15. After switching notes (in loadCurrentNote), call `this.updateLayerPanel()` to refresh the panel.

16. SVG icons to use:
    - Eye open: `<svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>`
    - Eye closed: `<svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>`
    - Lock open: `<svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 019.9-1"/></svg>`
    - Lock closed: `<svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>`
  </action>
  <verify>
Run `npm test` to ensure no regressions. Run the app with `npm start` or `npm run dev` and:
1. Press 'L' - layer panel should appear/disappear
2. Click '+' to add a layer
3. Double-click layer name to rename
4. Click eye icon to hide/show layer
5. Click lock icon to lock/unlock
6. Click up/down arrows to reorder
7. Draw on different layers, verify rendering order changes
8. Verify delete works (not on last layer)
  </verify>
  <done>
- Layer panel toggle works via button and 'L' keyboard shortcut
- Create, rename, delete layers all functional
- Reorder up/down changes rendering order correctly
- Visibility toggle hides/shows layer content (canvas + DOM elements)
- Lock toggle prevents drawing/editing on locked layer
- Active layer highlighted in panel
- Panel refreshes on note switch
  </done>
</task>

<task type="auto">
  <name>Task 3: Select-all respects active layer and final integration polish</name>
  <files>src/renderer.js</files>
  <action>
1. Update the select-all handler (Cmd+A / Ctrl+A):
   - Currently selects all objects across the note
   - Change to select all objects on the ACTIVE LAYER only:
     ```javascript
     // In the select all handler:
     const activeLayer = this.getActiveLayer();
     if (!activeLayer) return;
     const objectIds = [...new Set(activeLayer.lines.map(l => l.objectId))];
     ```

2. Update the clear-all button handler:
   - Clear should only clear the ACTIVE LAYER, not all layers
   - Set `activeLayer.lines = []`, `activeLayer.textItems = []`, `activeLayer.images = []`
   - Remove DOM elements with matching data-layer-id
   - Call saveState(), redraw()

3. Ensure the layer toggle button in the toolbar gets the `.active` class styling. Add to styles.css if not already covered:
   ```css
   #layer-toggle.active {
       color: rgba(59, 130, 246, 0.9);
   }
   ```

4. Update the `autoSave()` / save data flow to ensure layers are saved properly:
   - In whatever method prepares data for saving (the save handler), ensure notes are saved with their layers array intact
   - The notes array already contains the layers, so this should work if the save just serializes `this.notes`

5. When switching notes, close any layer name that is being edited (blur active contenteditable).

6. Add a soft limit warning: if user tries to add more than 10 layers, still allow it but log a console warning. No hard block.

7. Ensure the layer panel is hidden when the settings panel opens, and vice versa (both can't be open at once for visual cleanliness):
   - When opening settings panel, close layer panel
   - When opening layer panel, close settings panel

8. Make sure that when creating a new note (via the '+' button or 'N' key), the layer panel updates to show the new note's layers.
  </action>
  <verify>
Run `npm test`. Run the app and verify:
1. Cmd+A selects only active layer objects
2. Clear button clears only active layer
3. Creating a new note shows fresh layer panel
4. Save/reload preserves all layer state
5. Settings and layer panel don't overlap
  </verify>
  <done>
- Select-all scoped to active layer
- Clear scoped to active layer
- Layer panel and settings panel are mutually exclusive
- Layer state persists through save/load cycle
- New notes show correct layer panel state
- All 7 success criteria from the phase are met
  </done>
</task>

</tasks>

<verification>
- `npm test` passes
- Layer panel toggles with L key and button click
- Create/rename/delete/reorder/visibility/lock all work
- Drawing goes to active layer only
- Rendering order matches layer order
- Select-all and clear scope to active layer
- Layers persist across restart
- Undo/redo works with layer operations
- Shape selection (clicking inside fill area) works in all modes
</verification>

<success_criteria>
All 7 phase success criteria are met:
1. Users can create, rename, and delete layers from the layer panel
2. New drawings/shapes/text go to the active layer
3. Layers can be reordered with rendering order matching
4. Individual layers can be hidden/shown
5. Individual layers can be locked
6. Layer state persists across app restarts
7. Layer system works with existing undo/redo
</success_criteria>

<output>
After completion, create `.planning/phases/05-layers-and-layer-management/05-02-SUMMARY.md`
</output>
